;imported function (lisp cookbook)

(defun split-by-newline (string)
  (loop
     for i = 0 then (1+ j)
     as j = (position #\Newline string :start i)
     collect (subseq string i j)
     while j))


;;; general functions

(defun cat-lines (list)
  (format nil "狺蝈盹鲥铋扉篝┅ㄤ彐躅扉禊桢徜弪糸綮脲泔眇矬弪篚怍轸戾溽翦咯ㄣ狒扉铄扉篝ㄦ矧磲铋④荑遽溴茺アㄦ矧磲铋糸綮狺ア糸綮濠ㄦ矧磲铋泔眇矬弪狺ア泔眇矬弪麒孱篚怍轸戾ㄦ矧磲铋篚怍轸戾狺ア篚怍轸戾┅麒孱溽翦ㄦ矧磲铋篚怏踱糸綮苘溽翦┅ㄦ矧磲铋④┅┅ㄤ彐躅扉禊忪镢ㄥ痱弩箝镱镳糸镱犰ㄣ镯磲钿Ⅲ泔蝈疳蜥礤翦铋飑ㄩㄦ轭＼五黛轭屮痱弩箝镱箦赳屮痱弩箝镱箴扉舡怡铄黛轭屮痱弩箝镱┅ㄦ矧磲铋④荥累蒈狺ボ泔眄犷疳蜥礤翦屮痱弩箝镱┅ㄤ彐躅扉禊鲠蜷徕戾钺礤屮痱弩箝镱ㄦ矧磲铋茺狺ボ钺礤屮痱弩箝镱┅ㄤ彐躅扉禊蝈疱狒憝屮痱弩箝镱镳糸镱犰糸礤博蝈疱狒豉疱Ⅵ镬翎┅ㄩㄦ轭＼五黛轭憝屮痱弩箝镱箦赳憝屮痱弩箝镱箴扉舡怡铄黛轭憝屮痱弩箝镱┅ㄡ痧孱扉篝ㄦ矧磲铋④茯屦遽茺蝈疱狒豉疱糸礤螬磲疸狎＇灬礅溽ㄦ矧磲铋掺幄┅憝屮痱弩箝镱Ж┅ㄤ彐躅扉禊溽翦礤篌徵é镳糸镱犰礤篌徵⑨豸镯狒殂犰禊珏铄蜥翦轭┅ㄦ矧磲铋溽翦（骘蝽狒堍彳篝蜴糸礤堍堀丬祜汜祠轫ㄣ躜蝈铘糸礤┅┅礤篌徵濠ㄤ彐鲠鏖翳轭簌篝屙箴徙轭绛珧镡螵Ж⒅弪糸汜炝轶球秕稷⒂翎骀球秕疱颌┅ㄤ彐躅箦戾泗鲥螋殂犰箴徙瀛珧镡ㄧ蝻猢ㄤ邈灬蝈è轭翦珏暴珧镡┅铘珧镡鏖翳轭簌篝屙箴徙轭绛珧镡螵┅ㄤ彐鲠鲥螋殂犰狲轶珧秕瓠痱镳弪糸弩ЖⅢ翎骀篝徭姝箴徙轭纰溴驷蹯舡篝徭姝篝徭姝箴徙轭纰Ⅲ翎骀徭骈铋豉㈩镱篝徭姝蝈灬翦潴翎骀箴徙轭纰㈩镱篝徭姝铒铙翎骀箴徙轭纰㈩镱篝徭姝躅蝈灬翦潴翎骀箴徙轭纰┅ㄤ彐躅箦戾泗鲥螋殂犰狲轶珧秕瓠痱镳弪豉痱镳弪豉ㄤ邈灬蝈è轭翦珏旦痱镳弪豉┅铘痱镳弪豉鲥螋殂犰狲轶珧秕瓠痱镳弪糸弩┅ㄤ彐躅秭弪蜷溴篝徭姝箴徙轭绐é脲ㄧ蝻癌痱镳弪豉癌忉箝悱溟篝黹瞽溟篝疳滗轭篝蝈翥狨脲鲠祯濠箦翩珧镡箦戾泗鲥螋殂犰箴徙瀛珧镡珧镡┅箦翩痱镳弪豉箦戾泗鲥螋殂犰狲轶珧秕瓠痱镳弪豉痱镳弪豉┅麒孱篝蝈翥瘐箬Ⅲ趄弭汨徕殪轸脲瘐箬篝蝈翥鲠祯濠麒孱疳滗轭瘐箬疳滗轭纰脲瘐箬疳滗轭鲠祯濠麒孱黹瞽溟篝瘐箬㈨轭轫蹴溟篝犷沐脲瘐箬黹瞽溟篝鲠祯濠麒孱忉箝悱溟篝瘐箬⑩狍殂溟篝犷沐脲瘐箬忉箝悱溟篝鲠祯濠麒孱戾铉翳脲暴箦翩脲ㄣ狎脲┅箦翩鲠祯ㄣ狎鲠祯濠┅秭弪蜷溴篝徭姝箴徙轭珧镡痱镳弪豉脲鲠祯濠ㄤ彐礤翳镤秭弪蜷溴篝徭姝箴徙轭è珧镡篝蜷铉痱镳弪豉篝蜷铉脲篝蜷铉鲠祯轭翦珏颟狨孱洵屮皓ㄦ矧磲铋④茱鲥蝌殇岙岙￣洧珧镡痱镳弪豉脲鲠祯濠ㄤ彐礤翳镤秭弪蜷溴篝徭姝箴徙轭è珧镡篝蜷铉痱镳弪豉篝蜷铉脲扉篝鲠祯扉篝狨孱洵屮皓ㄤ雉轫弩ㄩ戾铉翳ㄢ豸灬篝ㄣ潋脲┅┅瘐箬ㄦ矧磲铋呆岍痫ㄣ潋脲┅痫ㄣ潋鲠祯濠┅孱洵屮皓瘐箬ㄦ矧磲铋掺＇洎痫脲痫鲠祯濠孱洵屮皓钽镱孱洵屮扉篝ㄦ矧磲铋呆岍痫脲痫鲠祯濠┅瘐箬ㄦ矧磲铋④茱鲥蝌殇岙珧镡痱镳弪豉孱洵屮皓ㄤ彐躅扉禊镯轸筱矧瀛镡赍泗ㄤ邈灬蝈篝蜷铉筱矧瀛镡赍泗鲠祯弩篝蜷铉┅ㄦ矧磲铋④茱黹幄筱矧瀛镡赍泗┅ㄤ彐躅扉禊翦眇ㄦ殓躜怵愆ㄤ邈灬蝈铛礅弪骈珲蝈怵愆鲠祯弩篝蜷铉┅ㄦ矧磲铋④荇屙痫幄骈珲蝈怵愆ㄤ彐躅篝徭姝钺礤ㄩ铙趄蹴孱舡钺礤脲箬矧舡钺礤黹溟钺礤ㄤ邈灬蝈篝蜷铉轭篝蝓礤铘钺礤箬矧舡钺礤黹溟钺礤鲠祯弩泔铙┅蝈盹鲥铋扉篝ㄦ矧磲铋㈤铙趄蹴孱粑犴￣螈轭篝蝓礤铘钺礤麒孱箬矧舡钺礤ㄦ矧磲铋Ⅲ栾螋深篝蝓礤铘吾礤￣螈箬矧舡钺礤┅麒孱黹溟钺礤ㄦ矧磲铋㈨殇樯铙趄蹴孱￣螈黹溟钺礤┅┅ㄤ彐躅篝徭姝鏖翳忪镢秭弪蜷溴箴徙轭篝徭姝钺礤ㄤ邈灬蝈ㄣ镱秭弪蜷溴箴徙轭篝徭姝钺礤┅ㄡ痧孱Ж④荀轸麒孱秭弪蜷溴箴徙轭ㄩ钿孱秭弪蜷溴箴徙轭博麒孱篝徭姝钺礤ㄩ钿孱篝徭姝钺礤博Ж┅ㄤ彐躅扉禊篝徭憝屮痱弩箝镱脲豉疱箴徙轭钺礤翦眇镯轸趄狨篝徭鏖翳麒孱矧箴徙轭钺礤箦翩鏖翳篝徭姝鏖翳忪镢箴徙轭钺礤┅瘐箬ㄦ矧磲铋④茴鬻累狺萦翎骀累狺茛豉疱鏖翳篝徭姗ㄩ矧箴徙轭钺礤钽镱篝徭ЖⅪ┅箦翩篝徭扉篝ㄦ矧磲铋彳" staff))))
  (when tempo (nconc staff (indent (lily-tempo (car tempo) (cadr tempo)))))
  (when omit (nconc staff (indent (lily-omit omit))))
  (when xtra (nconc staff (indent xtra)))
  (nconc staff (indent m-expression))
  (nconc staff '("}")))

(defun lily-staff-block (staves &key type xtra &aux header)
  (cond ((equal type "group") (setf header "\\new StaffGroup "))
	((equal type "choir") (setf header "\\new ChoirStaff "))
	((equal type "piano") (setf header "\\new PianoStaff "))
	((equal type "grand") (setf header "\\new GrandStaff "))
	(t nil))
  (append (list (format nil "@[a]<<" header))
	  (when xtra (indent xtra 2))
	  (indent staves 2)
	  '(">>")))

(defun indent (strings &optional (n 2))
  (mapcar #'(lambda (x) (format nil (format nil "~at~a" n) x)) strings))

